{% extends "base.html" %}

{% block title %}Dashboard - Synapse Finance{% endblock %}

{% block head_styles %}
{{ super() }}
<style>
    /* --- CSS Specific to Dashboard --- */
    .data-card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); margin-bottom: 1.5rem; min-height: 100px; display: flex; flex-direction: column; }
    .data-card h2 { color: #00bfa5; border-bottom: 1px solid #444; padding-bottom: 0.5rem; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; } .data-card h2 span { font-size: 0.9em; color: #aaa; font-weight: normal; margin-left: 0.25rem; }
    .data-content { font-size: 0.95rem; line-height: 1.7; color: #ccc; flex-grow: 1; overflow-y: auto; max-height: 450px; }
    .data-content strong { color: #00bfa5; margin-right: 0.5rem; font-weight: 500; } .data-content ul { list-style: none; padding: 0; } .data-content li { margin-bottom: 1em; border-bottom: 1px solid #333; padding-bottom: 0.8em; } .data-content li:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; } .data-content a { color: #00bfa5; text-decoration: none; } .data-content a:hover { text-decoration: underline; }
    .data-content::-webkit-scrollbar { width: 8px; } .data-content::-webkit-scrollbar-track { background: #2c2c2c; border-radius: 4px; } .data-content::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; border: 2px solid #2c2c2c; } .data-content::-webkit-scrollbar-thumb:hover { background-color: #777; }
    #symbolInput { background-color: #333; border: 1px solid #555; color: #e0e0e0; } #fetchDataBtn { background-color: #00bfa5; color: #121212; font-weight: 600; } #fetchDataBtn:hover { background-color: #008c7a; }
    .profile-area { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; min-height: 40px; } #profileInfo { display: flex; align-items: center; gap: 1rem; flex-grow: 1; } #companyLogo { width: 40px; height: 40px; object-fit: contain; border-radius: 0.25rem; background-color: #333; flex-shrink: 0; } #companyName { font-size: 1.5rem; font-weight: 600; color: #fff; }
    #addToWatchlistBtn { background-color: #374151; color: #d1d5db; border: 1px solid #4b5563; padding: 0.3rem 0.8rem; border-radius: 0.375rem; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 0.3rem; cursor: pointer; transition: background-color 0.2s ease; flex-shrink: 0; } #addToWatchlistBtn:hover:not(:disabled) { background-color: #4b5563; } #addToWatchlistBtn svg { width: 0.9rem; height: 0.9rem; } #addToWatchlistBtn:disabled { background-color: #4b5563; color: #6b7280; cursor: not-allowed; opacity: 0.6; }
    .error-message, .upgrade-message { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.9rem; } .error-message { color: #f44336; background-color: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); } .error-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; } .upgrade-message { color: #ffca28; background-color: rgba(255, 202, 40, 0.1); border: 1px solid rgba(255, 202, 40, 0.3); } .upgrade-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; } .upgrade-link { color: #00bfa5; font-weight: 500; text-decoration: underline; margin-left: 0.5rem;}
    #chartContainer { position: relative; height: 45vh; width: 100%; margin-top: 1rem; flex-grow: 1; }
    .time-period-btn { background-color: #333; color: #ccc; padding: 0.3rem 0.8rem; border: 1px solid #555; border-radius: 0.375rem; font-size: 0.8rem; margin-left: 0.5rem; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; } .time-period-btn:hover { background-color: #444; border-color: #777; } .time-period-btn.active { background-color: #00bfa5; color: #121212; border-color: #00bfa5; font-weight: 600; }
    .autocomplete-container { position: relative; width: 100%; max-width: 300px; } #suggestionsDropdown { position: absolute; top: 100%; left: 0; right: 0; background-color: #2c2c2c; border: 1px solid #555; border-top: none; border-radius: 0 0 0.375rem 0.375rem; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); } .suggestion-item { padding: 0.75rem 1rem; color: #ccc; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.9rem; } .suggestion-item:last-child { border-bottom: none; } .suggestion-item:hover { background-color: #444; color: #fff; } .suggestion-item strong { color: #e0e0e0; font-weight: 500; } .suggestion-item span { color: #aaa; margin-left: 0.5rem; font-size: 0.85rem; } #suggestionsDropdown:empty { display: none; } #suggestionsDropdown::-webkit-scrollbar { width: 6px; } #suggestionsDropdown::-webkit-scrollbar-track { background: #2c2c2c; } #suggestionsDropdown::-webkit-scrollbar-thumb { background-color: #555; border-radius: 3px; } #suggestionsDropdown::-webkit-scrollbar-thumb:hover { background-color: #777; }
    .card-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
    .market-list li { display: flex; justify-content: space-between; align-items: center; } .market-list .symbol-name { flex-grow: 1; margin-right: 1rem; } .market-list .price-change { text-align: right; min-width: 100px; } .market-list .change-positive { color: #4caf50; } .market-list .change-negative { color: #f44336; }
    #chartSection { display: flex; flex-direction: column;}
    #watchlistResult ul { list-style: none; padding: 0; margin: 0; } #watchlistResult li { display: flex; justify-content: space-between; align-items: center; padding: 0.2rem 0; border-bottom: 1px solid #333; font-size: 0.95rem; } #watchlistResult li:last-child { border-bottom: none; }
    .watchlist-symbol-btn { font-weight: 500; color: #e0e0e0; background: none; border: none; padding: 0.4rem; text-align: left; flex-grow: 1; cursor: pointer; border-radius: 0.25rem; transition: background-color 0.2s ease, color 0.2s ease; }
    .watchlist-symbol-btn:hover { background-color: #333; color: #00bfa5; }
    .remove-watchlist-btn { background-color: transparent; border: none; color: #f87171; cursor: pointer; padding: 0.2rem 0.4rem; margin-left: 1rem; font-size: 1.1rem; line-height: 1; transition: color 0.2s ease; flex-shrink: 0; } .remove-watchlist-btn:hover { color: #ef4444; }
    .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 191, 165, 0.9); color: #121212; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; visibility: hidden; font-size: 0.9rem; font-weight: 500; } .toast-notification.show { opacity: 1; visibility: visible; } .toast-notification.error { background-color: rgba(244, 67, 54, 0.9); color: white; }
    .fundamental-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.85rem; }
    .fundamental-table th, .fundamental-table td { border: 1px solid #333; padding: 0.5rem 0.75rem; text-align: left; white-space: nowrap; }
    .fundamental-table th { background-color: #2a2a2a; font-weight: 600; color: #ccc; }
    .fundamental-table td { color: #ddd; }
    .fundamental-table td:not(:first-child):not(.action-cell) { text-align: right; }
    .fundamental-table tr:nth-child(even) { background-color: #222; }
    .overflow-x-auto { overflow-x: auto; }
    .overflow-x-auto::-webkit-scrollbar { height: 6px; }
    .overflow-x-auto::-webkit-scrollbar-track { background: #2c2c2c; border-radius: 3px; }
    .overflow-x-auto::-webkit-scrollbar-thumb { background-color: #555; border-radius: 3px; }
    .overflow-x-auto::-webkit-scrollbar-thumb:hover { background-color: #777; }
    
    /* --- NEW: Alert Section Styles --- */
    #alert-form { display: flex; gap: 0.75rem; align-items: center; margin-top: 1rem; }
    #alert-form select, #alert-form input { background-color: #333; border: 1px solid #555; color: #e0e0e0; padding: 0.4rem 0.6rem; border-radius: 0.25rem; font-size: 0.9rem; }
    #alert-form button { background-color: #00bfa5; color: #121212; font-weight: 600; padding: 0.4rem 0.8rem; border-radius: 0.25rem; }
    #alert-list { list-style: none; padding: 0; margin-top: 1rem; }
    #alert-list li { display: flex; justify-content: space-between; align-items: center; background-color: #2a2a2a; padding: 0.5rem 0.75rem; border-radius: 0.25rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .remove-alert-btn { background: none; border: none; color: #f87171; font-size: 1.2rem; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
    <div class="mb-6 p-4 bg-[#1e1e1e] rounded-lg border border-[#333] flex-shrink-0">
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
            <div class="autocomplete-container flex-grow">
                <label for="symbolInput" class="sr-only">Stock Symbol</label>
                <input type="text" id="symbolInput" placeholder="Search Symbol (e.g., AAPL)" class="p-3 rounded-md text-lg w-full" autocomplete="off">
                <div id="suggestionsDropdown"></div>
            </div>
            <button id="fetchDataBtn" onclick="fetchData()" class="p-3 rounded-md text-lg w-full sm:w-auto">Get Data</button>
        </div>
        <div class="profile-area">
            <div id="profileInfo">
                <img id="companyLogo" src="https://placehold.co/40x40/333/555?text=?" alt="Company Logo">
                <span id="companyName">Enter a symbol to load data</span>
            </div>
            <button id="addToWatchlistBtn" style="display: none;" title="Add to Watchlist">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> </svg>
                <span>Watchlist</span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-grow">
        <div class="flex flex-col gap-6 md:col-span-1">
            <section id="gainersSection" class="data-card">
                <h2><svg class="card-icon text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /> </svg>Top Gainers</h2>
                <div id="gainersResult" class="data-content"></div>
            </section>
            <section id="losersSection" class="data-card">
                 <h2><svg class="card-icon text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6 9 12.75l4.286-4.286a11.948 11.948 0 0 1 4.306 6.43l.776 2.898m0 0 3.182-5.511m-3.182 5.51-5.511-3.181" /> </svg>Top Losers</h2>
                <div id="losersResult" class="data-content"></div>
            </section>
            <section id="activeSection" class="data-card">
                <h2><svg class="card-icon text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672Zm-7.518-.267A8.25 8.25 0 1 1 20.25 10.5M8.288 14.212A5.25 5.25 0 1 1 17.25 10.5" /> </svg>Most Active</h2>
                <div id="activeResult" class="data-content"></div>
            </section>
            <section id="watchlistSection" class="data-card">
                <h2><svg class="card-icon text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.418a.562.562 0 0 1 .321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988h5.418a.563.563 0 0 0 .475-.31L11.48 3.5Z" /> </svg> Watchlist </h2>
                <div id="watchlistResult" class="data-content">
                     {% if watchlist and watchlist|length > 0 %}
                         <ul id="watchlist-list">
                             {% for item in watchlist %}
                                 <li data-symbol="{{ item.symbol }}">
                                     <button class="watchlist-symbol-btn" onclick="fetchData('{{ item.symbol | escape }}')">{{ item.symbol }}</button>
                                     <button class="remove-watchlist-btn" title="Remove {{ item.symbol }}" onclick="removeFromWatchlist('{{ item.symbol | escape }}')"> &times; </button>
                                 </li>
                             {% endfor %}
                         </ul>
                     {% else %}
                         <p class="text-gray-400 text-sm">Your watchlist is empty.</p>
                     {% endif %}
                </div>
            </section>
         </div>

         <div class="flex flex-col gap-6 md:col-span-2">
             <section id="chartSection" class="data-card">
                 <div class="flex flex-wrap justify-between items-center gap-y-2 mb-4 flex-shrink-0">
                     <h2><svg class="card-icon text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 3 4.5h.75m0 0h.75A.75.75 0 0 0 5.25 6v.75m0 0H3.75m0 0a1.125 1.125 0 0 1-1.125-1.125V3.75m1.125 1.125c-.621 0-1.125.504-1.125 1.125v3.75c0 .621.504 1.125 1.125 1.125h.007v-.007h-.007Zm1.5 0c.621 0 1.125-.504 1.125-1.125V3.75c0-.621-.504-1.125-1.125-1.125H3.75m1.125 1.125c-.621 0-1.125.504-1.125 1.125v3.75c0 .621.504 1.125 1.125 1.125h.007v-.007h-.007Zm3.75 0c.621 0 1.125-.504 1.125-1.125V3.75c0-.621-.504-1.125-1.125-1.125H3.75M9 15l1.125-3L12 15" /> </svg>Price Chart <span id="chartSymbol"></span></h2>
                     <div id="chartTimePeriods" class="flex-shrink-0">
                         <button class="time-period-btn" data-period="1m" onclick="updateChartPeriod('1m')">1M</button>
                         <button class="time-period-btn" data-period="6m" onclick="updateChartPeriod('6m')">6M</button>
                         <button class="time-period-btn active" data-period="1y" onclick="updateChartPeriod('1y')">1Y</button>
                         <button class="time-period-btn" data-period="5y" onclick="updateChartPeriod('5y')">5Y</button>
                         <button class="time-period-btn" data-period="all" onclick="updateChartPeriod('all')">All</button>
                     </div>
                 </div>
                 <div id="chartContainer"><canvas id="priceChart"></canvas></div>
                 <div id="chartError" class="data-content mt-4 flex-shrink-0"></div>
             </section>

             <!-- NEW: Price Alerts Card -->
             <section id="alertsSection" class="data-card" style="display: none;">
                <h2>
                    <svg class="card-icon text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                    </svg>
                    Price Alerts <span id="alertSymbol"></span>
                </h2>
                <div id="alertsResult" class="data-content">
                    <p class="text-sm text-gray-400">Set a price alert to be notified when the stock reaches a specific price.</p>
                    <form id="alert-form">
                        <span>Notify me when price is</span>
                        <select name="condition" id="alert-condition">
                            <option value="above">Above</option>
                            <option value="below">Below</option>
                        </select>
                        <input type="number" step="any" name="target_price" id="alert-price" placeholder="Enter price" required>
                        <button type="submit">Set Alert</button>
                    </form>
                    <ul id="alert-list"></ul>
                </div>
             </section>

             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                 <section id="quoteSection" class="data-card">
                     <h2><svg class="card-icon text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /> </svg>Quote <span id="quoteSymbol"></span></h2>
                     <div id="quoteResult" class="data-content"></div>
                 </section>
                 <section id="ratingSection" class="data-card">
                     <h2><svg class="card-icon text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /> </svg>Rating <span id="ratingSymbol"></span></h2>
                     <div id="ratingResult" class="data-content"></div>
                 </section>
                 <section id="technicalsSection" class="data-card">
                     <h2><svg class="card-icon text-teal-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /> </svg>Technicals <span id="techSymbol"></span></h2>
                     <div id="technicalsResult" class="data-content"></div>
                 </section>
                 <section id="earningsSection" class="data-card">
                     <h2><svg class="card-icon text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" /> </svg>Earnings <span id="earningsSymbol"></span></h2>
                     <div id="earningsResult" class="data-content"></div>
                 </section>
             </div>
             <section id="newsSection" class="data-card lg:col-span-2">
                 <h2><svg class="card-icon text-pink-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /> </svg>News <span id="newsSymbol"></span></h2>
                 <div id="newsResult" class="data-content"></div>
             </section>
              <section id="incomeStatementSection" class="data-card lg:col-span-2">
                <h2><svg class="card-icon text-lime-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /> </svg> Income Statement (Annual) <span id="incomeSymbol"></span> </h2>
                <div id="incomeStatementResult" class="data-content overflow-x-auto"></div>
             </section>
             <section id="balanceSheetSection" class="data-card lg:col-span-2">
                <h2><svg class="card-icon text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-1.481L10.5 17.25m3.75-4.846L15 11.25m-4.5 1.481L10.5 11.25m6.75 7.5 2.25-2.25m0 0-2.25-2.25M17.25 15l-2.25 2.25m2.25-2.25 2.25 2.25M4.5 21.75l-2.25-2.25M4.5 21.75l2.25-2.25M4.5 21.75l2.25 2.25M4.5 21.75l-2.25 2.25m2.25-15l-2.25-2.25M4.5 6.75l2.25-2.25M4.5 6.75l-2.25 2.25M4.5 6.75l2.25 2.25" /> </svg> Balance Sheet (Annual) <span id="balanceSymbol"></span> </h2>
                <div id="balanceSheetResult" class="data-content overflow-x-auto"></div>
             </section>
         </div>
    <div id="toast-notification" class="toast-notification"></div>
{% endblock %}


{% block body_scripts %}
{{ super() }}
<script>
    // --- START: MODIFIED SCRIPT ---
    const quoteResultEl=document.getElementById("quoteResult"),ratingResultEl=document.getElementById("ratingResult"),technicalsResultEl=document.getElementById("technicalsResult"),newsResultEl=document.getElementById("newsResult"),earningsResultEl=document.getElementById("earningsResult"),companyLogoEl=document.getElementById("companyLogo"),companyNameEl=document.getElementById("companyName"),chartErrorEl=document.getElementById("chartError"),gainersResultEl=document.getElementById("gainersResult"),losersResultEl=document.getElementById("losersResult"),activeResultEl=document.getElementById("activeResult"),quoteSymbolEl=document.getElementById("quoteSymbol"),ratingSymbolEl=document.getElementById("ratingSymbol"),techSymbolEl=document.getElementById("techSymbol"),newsSymbolEl=document.getElementById("newsSymbol"),earningsSymbolEl=document.getElementById("earningsSymbol"),chartSymbolEl=document.getElementById("chartSymbol"),chartTimePeriodsContainer=document.getElementById("chartTimePeriods"),symbolInputEl=document.getElementById("symbolInput"),suggestionsDropdownEl=document.getElementById("suggestionsDropdown"),watchlistResultEl=document.getElementById("watchlistResult"),watchlistListEl=document.getElementById("watchlist-list"),addToWatchlistBtn=document.getElementById("addToWatchlistBtn"),toastNotificationEl=document.getElementById("toast-notification"),incomeSymbolEl=document.getElementById("incomeSymbol"),incomeStatementResultEl=document.getElementById("incomeStatementResult"),balanceSymbolEl=document.getElementById("balanceSymbol"),balanceSheetResultEl=document.getElementById("balanceSheetResult");
    
    // --- NEW: Alert Elements ---
    const alertsSection = document.getElementById('alertsSection');
    const alertSymbolEl = document.getElementById('alertSymbol');
    const alertForm = document.getElementById('alert-form');
    const alertListEl = document.getElementById('alert-list');

    const skeletonHTML = `<div class="skeleton-card"><div class="skeleton-line" style="width: 80%;"></div><div class="skeleton-line" style="width: 90%;"></div><div class="skeleton-line" style="width: 75%;"></div><div class="skeleton-line" style="width: 85%;"></div></div>`;
    const marketListSkeletonHTML = `<div class="skeleton-card"><div class="skeleton-line" style="width: 95%; height: 2rem; margin-bottom: 0.5rem;"></div><div class="skeleton-line" style="width: 95%; height: 2rem; margin-bottom: 0.5rem;"></div><div class="skeleton-line" style="width: 95%; height: 2rem;"></div></div>`;
    const placeholderLogo="https://placehold.co/40x40/333/555?text=?",errorIconSvg='<svg class="error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>',upgradeIconSvg='<svg class="upgrade-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.418a.562.562 0 0 1 .321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988h5.418a.563.563 0 0 0 .475-.31L11.48 3.5Z" /></svg>';
    let priceChartInstance=null,currentHistoricalData=[],currentSymbolEodhd="",currentSymbolFmp="",searchDebounceTimeout,toastTimeout;
    
    function setLoadingState(el, type = 'card') { if(el) { el.innerHTML = type === 'market' ? marketListSkeletonHTML : skeletonHTML; } }
    function setErrorState(e,t="Error fetching data.",n=null){if(!e)return;let o="";o=403===n?`<div class="upgrade-message">${upgradeIconSvg}<span>Pro subscription required. <a href="/pricing" class="upgrade-link">Upgrade</a></span></div>`:`<div class="error-message">${errorIconSvg}<span>${t}</span></div>`,e.innerHTML=o}
    function clearContent(e){if(e)e.innerHTML=""}
    function clearChart(){priceChartInstance&&(priceChartInstance.destroy(),priceChartInstance=null),clearContent(chartErrorEl)}
    function showToast(e,t=!1){if(!toastNotificationEl)return;toastNotificationEl.textContent=e,toastNotificationEl.className="toast-notification",t&&toastNotificationEl.classList.add("error"),setTimeout(()=>{toastNotificationEl.classList.add("show")},10),clearTimeout(toastTimeout),toastTimeout=setTimeout(()=>{toastNotificationEl.classList.remove("show")},3e3)}
    function formatLargeNumber(e){if(null==e||void 0===e||isNaN(e))return"N/A";if(Math.abs(e)>=1e12)return(e/1e12).toFixed(2)+" T";if(Math.abs(e)>=1e9)return(e/1e9).toFixed(2)+" B";if(Math.abs(e)>=1e6)return(e/1e6).toFixed(2)+" M";return e.toLocaleString(void 0,{maximumFractionDigits:2})}
    function formatPercentage(e,t=2){return null==e||void 0===e||isNaN(e)?"N/A":(100*e).toFixed(t)+"%"}
    async function fetchData(e=null){const t=e||(symbolInputEl?symbolInputEl.value.trim():null);if(!t)return;const n=t.toUpperCase();currentSymbolEodhd=n.includes(".")?n:n+".US",currentSymbolFmp=n.replace(/\.(US|CC|INDX)$/i,""),addToWatchlistBtn&&(addToWatchlistBtn.style.display="none"),alertsSection&&(alertsSection.style.display="none"),setLoadingState(quoteResultEl),setLoadingState(ratingResultEl),setLoadingState(technicalsResultEl),setLoadingState(newsResultEl),setLoadingState(earningsResultEl),clearChart(),setLoadingState(chartErrorEl),setLoadingState(incomeStatementResultEl),setLoadingState(balanceSheetResultEl),companyLogoEl&&(companyLogoEl.src=placeholderLogo),companyNameEl&&(companyNameEl.textContent="Loading..."),currentHistoricalData=[];try{quoteSymbolEl&&(quoteSymbolEl.textContent=`(${currentSymbolEodhd}`),ratingSymbolEl&&(ratingSymbolEl.textContent=`(${currentSymbolFmp}`),techSymbolEl&&(techSymbolEl.textContent=`(${currentSymbolEodhd}`),newsSymbolEl&&(newsSymbolEl.textContent=`(${currentSymbolEodhd}`),earningsSymbolEl&&(earningsSymbolEl.textContent=`(${currentSymbolFmp}`),chartSymbolEl&&(chartSymbolEl.textContent=`(${currentSymbolEodhd}`),incomeSymbolEl&&(incomeSymbolEl.textContent=`(${currentSymbolFmp}`),balanceSymbolEl&&(balanceSymbolEl.textContent=`(${currentSymbolFmp}`),alertSymbolEl&&(alertSymbolEl.textContent=`(${currentSymbolFmp}`),setActiveTimePeriodButton("1y")}catch(o){return showToast(`Error initializing UI: ${o.message}. Check HTML IDs.`,!0),setErrorState(quoteResultEl,"UI Init Error"),setErrorState(ratingResultEl,"UI Init Error"),setErrorState(technicalsResultEl,"UI Init Error"),setErrorState(newsResultEl,"UI Init Error"),setErrorState(earningsResultEl,"UI Init Error"),setErrorState(chartErrorEl,"UI Init Error"),setErrorState(incomeStatementResultEl,"UI Init Error"),void setErrorState(balanceSheetResultEl,"UI Init Error")}try{const e=await Promise.allSettled([fetch(`/technicals/${currentSymbolEodhd}`),fetch(`/profile/${currentSymbolFmp}`),fetch(`/quote/${currentSymbolEodhd}`),fetch(`/rating/${currentSymbolFmp}`),fetch(`/news/${currentSymbolEodhd}`),fetch(`/earnings/${currentSymbolFmp}`),fetch(`/fundamentals/income/${currentSymbolFmp}`),fetch(`/fundamentals/balance/${currentSymbolFmp}`)]);await processTechnicalsResponse(e[0]);const t=await processProfileResult(e[1]);if(t&&currentSymbolFmp){addToWatchlistBtn&&(addToWatchlistBtn.style.display="inline-flex",addToWatchlistBtn.disabled=!1,addToWatchlistBtn.querySelector("span")&&(addToWatchlistBtn.querySelector("span").textContent="Watchlist"),addToWatchlistBtn.onclick=()=>addToWatchlist(currentSymbolFmp)),alertsSection&&(alertsSection.style.display="block"),fetchAndDisplayAlerts(currentSymbolFmp)}else addToWatchlistBtn&&(addToWatchlistBtn.style.display="none"),alertsSection&&(alertsSection.style.display="none");await processQuoteResult(e[2],quoteResultEl),await processRatingResult(e[3],ratingResultEl),await processNewsResult(e[4],newsResultEl),await processEarningsResult(e[5],earningsResultEl),await processIncomeStatement(e[6],incomeStatementResultEl),await processBalanceSheet(e[7],balanceSheetResultEl)}catch(o){setErrorState(technicalsResultEl,"Fetch/Process Error"),setErrorState(chartErrorEl,"Chart Error"),setErrorState(quoteResultEl,"Load error"),setErrorState(ratingResultEl,"Load error"),setErrorState(newsResultEl,"Load error"),setErrorState(earningsResultEl,"Load error"),setErrorState(incomeStatementResultEl,"Load error"),setErrorState(balanceSheetResultEl,"Load error"),companyNameEl&&setErrorState(companyNameEl,"Error loading"),companyLogoEl&&(companyLogoEl.src=placeholderLogo),addToWatchlistBtn&&(addToWatchlistBtn.style.display="none")}}
    if(symbolInputEl&&suggestionsDropdownEl){symbolInputEl.addEventListener("input",e=>{const t=e.target.value.trim();clearTimeout(searchDebounceTimeout),t.length<1?suggestionsDropdownEl.innerHTML="":searchDebounceTimeout=setTimeout(async()=>{try{const e=await fetch(`/search/${t}`);if(!e.ok)throw new Error(`Search API Error: ${e.statusText}`);const n=await e.json();displaySuggestions(n)}catch(o){suggestionsDropdownEl.innerHTML=""}},300)}),symbolInputEl.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),fetchData(),suggestionsDropdownEl.innerHTML="",symbolInputEl.blur())})}function displaySuggestions(e){if(!e||!e.length)return void(suggestionsDropdownEl.innerHTML="");let t="";e.forEach(e=>{const n=e.symbol||"N/A",o=e.name||"N/A",r=n.replace(/'/g,"\\'");t+=`<div class="suggestion-item" onclick="selectSuggestion('${r}')"><strong>${n}</strong><span>${o}</span></div>`}),suggestionsDropdownEl.innerHTML=t}function selectSuggestion(e){symbolInputEl&&(symbolInputEl.value=e),suggestionsDropdownEl&&(suggestionsDropdownEl.innerHTML=""),fetchData(e)}document.addEventListener("click",e=>{symbolInputEl&&suggestionsDropdownEl&&(symbolInputEl.contains(e.target)||suggestionsDropdownEl.contains(e.target)||(suggestionsDropdownEl.innerHTML=""))});
    function updateChartPeriod(e,t=null){if("undefined"==typeof dateFns)return void setErrorState(chartErrorEl,"Charting library error.");const{subDays:n,subWeeks:o,subMonths:r,subYears:a,parseISO:s,isAfter:c,format:i}=dateFns;const l=t||currentHistoricalData;if(!l||!l.length)return null===t&&setErrorState(chartErrorEl,"No historical data loaded to display chart."),void setActiveTimePeriodButton(e);const d=l.map(e=>{try{return{...e,dateObj:s(e.date)}}catch(u){return null}}).filter(e=>null!==e&&e.dateObj instanceof Date&&!isNaN(e.dateObj)).sort((e,t)=>e.dateObj-t.dateObj);if(!d.length||!d[d.length-1].dateObj)return setErrorState(chartErrorEl,"Invalid date data for charting."),void setActiveTimePeriodButton(e);const m=d[d.length-1].dateObj;let p=null;switch(e){case"1d":p=n(m,5);break;case"1w":p=o(m,1);break;case"1m":p=r(m,1);break;case"6m":p=r(m,6);break;case"1y":p=a(m,1);break;case"5y":p=a(m,5);break;case"all":default:p=null}const g=p?d.filter(e=>!c(p,e.dateObj)):d;g.length?(clearContent(chartErrorEl),renderPriceChart(g.map(e=>({date:i(e.dateObj,"yyyy-MM-dd"),close:e.close})))):setErrorState(chartErrorEl,`No data available for the selected period (${e}).`),setActiveTimePeriodButton(e)}
    function setActiveTimePeriodButton(e){if(!chartTimePeriodsContainer)return;const t=chartTimePeriodsContainer.querySelectorAll(".time-period-btn");t.forEach(t=>{t.classList.toggle("active",t.dataset.period===e)})}
    function renderPriceChart(e){const t=document.getElementById("priceChart");if(!t)return;const n=t.getContext("2d");if(clearChart(),!e||!Array.isArray(e)||!e.length)return void setErrorState(chartErrorEl,"Not enough data points to render the chart.");const o=e.map(e=>e.date),r=e.map(e=>parseFloat(e.close)).filter(e=>!isNaN(e));if(!r.length)return void setErrorState(chartErrorEl,"No valid price data to render the chart.");priceChartInstance=new Chart(n,{type:"line",data:{labels:o,datasets:[{label:"Closing Price",data:r,borderColor:"#00bfa5",backgroundColor:"rgba(0, 191, 165, 0.1)",borderWidth:1.5,pointRadius:0,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{color:"#aaa",maxRotation:0,autoSkip:!0,maxTicksLimit:8},grid:{color:"rgba(255, 255, 255, 0.1)"}},y:{ticks:{color:"#aaa"},grid:{color:"rgba(255, 255, 255, 0.1)"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,mode:"index",intersect:!1,backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",padding:10,callbacks:{title:function(e){try{if("undefined"!=typeof dateFns){const t=dateFns.parseISO(e[0].label);return dateFns.format(t,"MMM d, Fifa")}}catch(t){}return e[0].label}}}}}})}
    async function processTechnicalsResponse(e){try{if("fulfilled"===e.status&&e.value.ok){const t=await e.value.json();t&&t.indicators&&t.history?(processTechnicalsResultData(t.indicators,technicalsResultEl),currentHistoricalData=t.history,updateChartPeriod("1y"),clearContent(chartErrorEl)):(setErrorState(technicalsResultEl,"Invalid technicals data format."),setErrorState(chartErrorEl,"Chart error: Invalid history data."))}else if("fulfilled"===e.status){const t=await e.value.json().catch(()=>({error:"Failed to parse technicals error"}));const n=`Error ${e.value.status}: ${t?.error||e.value.statusText}`;setErrorState(technicalsResultEl,n,e.value.status),setErrorState(chartErrorEl,`Chart error: ${n}`,e.value.status)}else setErrorState(technicalsResultEl,"Network error fetching technicals."),setErrorState(chartErrorEl,"Chart error: Network error.")}catch(t){setErrorState(technicalsResultEl,"Error processing technicals data."),setErrorState(chartErrorEl,"Chart error: Processing error.")}}
    async function processProfileResult(e){try{if("fulfilled"===e.status&&e.value.ok){const t=await e.value.json();const n=t?.image??placeholderLogo,o=t?.companyName??"N/A";return companyLogoEl&&(companyLogoEl.src=n,companyLogoEl.onerror=()=>{companyLogoEl&&(companyLogoEl.src=placeholderLogo)}),companyNameEl&&(companyNameEl.textContent=o),!0}if("fulfilled"===e.status){const t=await e.value.json().catch(()=>({error:"Unknown profile error"}));companyNameEl&&setErrorState(companyNameEl,`Profile Error ${e.value.status}`,e.value.status),companyLogoEl&&(companyLogoEl.src=placeholderLogo)}else companyNameEl&&setErrorState(companyNameEl,"Network error fetching profile."),companyLogoEl&&(companyLogoEl.src=placeholderLogo)}catch(t){companyNameEl&&setErrorState(companyNameEl,"Error processing profile data."),companyLogoEl&&(companyLogoEl.src=placeholderLogo)}return!1}
    function processTechnicalsResultData(e,t){if(!t)return;clearContent(t);try{e&&"object"==typeof e&&null!==e?t.innerHTML=`<strong>Last Close:</strong> ${e.last_close?.toFixed(2)??"N/A"}<br><strong>50-Day SMA:</strong> ${e.sma_50?.toFixed(2)??"N/A"}<br><strong>200-Day SMA:</strong> ${e.sma_200?.toFixed(2)??"N/A"}<br><strong>RSI (14):</strong> ${e.rsi_14?.toFixed(2)??"N/A"}<br><strong>MACD Line:</strong> ${e.macd_line?.toFixed(2)??"N/A"}<br><strong>MACD Hist:</strong> ${e.macd_hist?.toFixed(2)??"N/A"}<br><strong>MACD Signal:</strong> ${e.macd_signal?.toFixed(2)??"N/A"}<br><strong>As of:</strong> ${e.last_calculation_date||"N/A"}`:setErrorState(t,"Could not process technical indicators.")}catch(n){setErrorState(t,"Error displaying technicals.")}}
    async function processQuoteResult(e,t){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const n=await e.value.json();let o=`<strong>Price:</strong> ${n.close?.toFixed(2)??"N/A"}<br>`;const r=0===n.change?"#aaa":n.change>0?"#4caf50":"#f44336",a=n.change>=0?"+":"";o+=`<strong>Change:</strong> <span style="color: ${r};">${a}${n.change?.toFixed(2)??"N/A"} (${a}${n.change_p?.toFixed(2)??"N/A"}%)</span><br>`,o+=`<strong>Volume:</strong> ${n.volume?.toLocaleString()??"N/A"}<br>`;let s="N/A";n.timestamp&&(s=new Date(1e3*n.timestamp).toLocaleString()),o+=`<strong>Timestamp:</strong> ${s}`,t.innerHTML=o}else if("fulfilled"===e.status){const n=await e.value.json().catch(()=>({error:"Failed to parse quote error"}));setErrorState(t,`Error ${e.value.status}: ${n?.error||e.value.statusText}`,e.value.status)}else setErrorState(t,"Network error fetching quote.")}catch(n){setErrorState(t,"Error processing quote data.")}}
    async function processRatingResult(e,t){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const n=await e.value.json();const o=Array.isArray(n)&&n.length>0?n[0]:"object"==typeof n&&null!==n&&!Array.isArray(n)?n:null;o&&Object.keys(o).length>0? (()=>{const e=o.ratingRecommendation||"N/A",n=o.ratingScore||"N/A",r=o.date||"N/A";let c="#aaa";e.toLowerCase().includes("buy")?c="#4caf50":e.toLowerCase().includes("sell")?c="#f44336":e.toLowerCase().includes("hold")&&(c="#ffc107"),t.innerHTML=`<strong>Recommendation:</strong> <span style="color: ${c}; font-weight: bold;">${e}</span><br><strong>Score:</strong> ${n}<br><strong>Date:</strong> ${r}`})():t.innerHTML="No rating data available."}else if("fulfilled"===e.status){const n=await e.value.json().catch(()=>({error:"Failed to parse rating error"}));setErrorState(t,`Error ${e.value.status}: ${n?.error||e.value.statusText}`,e.value.status)}else setErrorState(t,"Network error fetching rating.")}catch(n){setErrorState(t,"Error processing rating data.")}}
    async function processNewsResult(e,t){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const n=await e.value.json();if(Array.isArray(n)&&n.length>0){let e='<ul class="space-y-3">';n.slice(0,5).forEach(t=>{let n="N/A";t.date&&(n=new Date(t.date.replace(" ","T")+"Z").toLocaleDateString());const o=t.title||"No Title",r=t.link||"#",a=t.content?.substring(0,100)||"No snippet available.",s=t.content?.length>100?"...":"";e+=`<li class="pb-3 border-b border-gray-700 last:border-b-0"><strong><a href="${r}" target="_blank" rel="noopener noreferrer" class="hover:text-[#00bfa5] transition-colors">${o}</a></strong><br><small class="text-gray-400">${n}</small><br><p class="text-sm mt-1 text-gray-300">${a}${s}</p></li>`}),e+="</ul>",t.innerHTML=e}else t.innerHTML="No recent news found."}else if("fulfilled"===e.status){const n=await e.value.json().catch(()=>({error:"Failed to parse news error"}));setErrorState(t,`Error ${e.value.status}: ${n?.error||e.value.statusText}`,e.value.status)}else setErrorState(t,"Network error fetching news.")}catch(n){setErrorState(t,"Error processing news data.")}}
    async function processEarningsResult(e,t){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const n=await e.value.json();if(Array.isArray(n)&&n.length>0){let e='<ul class="space-y-2">';n.slice(0,4).forEach(t=>{let n="N/A";t.date&&(n=new Date(t.date+"T00:00:00Z").toLocaleDateString());const o=t.epsactual??t.eps_actual,r=t.epsestimate??t.eps_estimated;let a="";"number"==typeof o&&"number"==typeof r&&(a=` | Surprise: <span style="color: ${o-r>=0?"#4caf50":"#f44336"};">${(o-r).toFixed(2)}</span>`),e+=`<li class="pb-2 border-b border-gray-700 last:border-b-0"><strong>Date:</strong> ${n}<br><strong>EPS:</strong> Actual: ${o?.toFixed(2)??"N/A"} | Estimate: ${r?.toFixed(2)??"N/A"}${a}</li>`}),e+="</ul>",t.innerHTML=e}else t.innerHTML="No recent earnings data found."}else if("fulfilled"===e.status){const n=await e.value.json().catch(()=>({error:"Failed to parse earnings error"}));setErrorState(t,`Error ${e.value.status}: ${n?.error||e.value.statusText}`,e.value.status)}else setErrorState(t,"Network error fetching earnings.")}catch(n){setErrorState(t,"Error processing earnings data.")}}
    async function processIncomeStatement(e,t){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const n=await e.value.json();if(Array.isArray(n)&&n.length>0){const e=n.slice(0,5).reverse();let o='<div class="overflow-x-auto"><table class="fundamental-table"><thead><tr><th>Metric</th>';e.forEach(e=>{o+=`<th>${e.calendarYear||e.date.substring(0,4)}</th>`}),o+="</tr></thead><tbody>";const r=[{key:"revenue",label:"Revenue"},{key:"grossProfit",label:"Gross Profit"},{key:"operatingIncome",label:"Operating Income"},{key:"netIncome",label:"Net Income"},{key:"eps",label:"EPS",format:"number",decimals:2}],a=[{label:"Gross Profit Margin",calculate:e=>e.revenue&&0!==e.revenue?e.grossProfit/e.revenue:null,format:"percentage"},{label:"Operating Margin",calculate:e=>e.revenue&&0!==e.revenue?e.operatingIncome/e.revenue:null,format:"percentage"},{label:"Net Profit Margin",calculate:e=>e.revenue&&0!==e.revenue?e.netIncome/e.revenue:null,format:"percentage"}];r.forEach(t=>{o+=`<tr><td>${t.label}</td>`,e.forEach(e=>{let n="N/A";const r=e[t.key];"number"===t.format&&"number"==typeof r?n=r.toFixed(void 0!==t.decimals?t.decimals:2):"number"==typeof r&&(n=formatLargeNumber(r)),o+=`<td>${n}</td>`}),o+="</tr>"}),a.forEach(t=>{o+=`<tr><td>${t.label}</td>`,e.forEach(e=>{let n="N/A";const r=t.calculate(e);"percentage"===t.format&&(n=formatPercentage(r)),o+=`<td>${n}</td>`}),o+="</tr>"}),o+="</tbody></table></div>",t.innerHTML=o}else t.innerHTML='<p class="text-gray-400 text-sm">No annual income statement data found.</p>'}else if("fulfilled"===e.status){const n=await e.value.json().catch(()=>({error:"Failed to parse error response"}));setErrorState(t,`Error: ${n?.error||e.value.statusText}`,e.value.status)}else setErrorState(t,"Network error fetching income statement.")}catch(n){setErrorState(t,"Error displaying income statement data.")}}
    async function processBalanceSheet(e,t){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const n=await e.value.json();if(Array.isArray(n)&&n.length>0){const e=n.slice(0,5).reverse();let o='<div class="overflow-x-auto"><table class="fundamental-table"><thead><tr><th>Metric</th>';e.forEach(e=>{o+=`<th>${e.calendarYear||e.date.substring(0,4)}</th>`}),o+="</tr></thead><tbody>";const r=[{key:"totalAssets",label:"Total Assets"},{key:"totalLiabilities",label:"Total Liabilities"},{key:"totalStockholdersEquity",label:"Total Equity"},{key:"cashAndCashEquivalents",label:"Cash & Equivalents"},{key:"totalDebt",label:"Total Debt"}],a=[{label:"Debt-to-Equity",calculate:e=>e.totalStockholdersEquity&&0!==e.totalStockholdersEquity&&"number"==typeof e.totalDebt?e.totalDebt/e.totalStockholdersEquity:null,format:"number",decimals:2}];r.forEach(t=>{o+=`<tr><td>${t.label}</td>`,e.forEach(e=>{const n="number"==typeof e[t.key]?formatLargeNumber(e[t.key]):"N/A";o+=`<td>${n}</td>`}),o+="</tr>"}),a.forEach(t=>{o+=`<tr><td>${t.label}</td>`,e.forEach(e=>{let n="N/A";const r=t.calculate(e);"number"===t.format&&"number"==typeof r?n=r.toFixed(void 0!==t.decimals?t.decimals:2):"percentage"===t.format&&(n=formatPercentage(r)),o+=`<td>${n}</td>`}),o+="</tr>"}),o+="</tbody></table></div>",t.innerHTML=o}else t.innerHTML='<p class="text-gray-400 text-sm">No annual balance sheet data found.</p>'}else if("fulfilled"===e.status){const n=await e.value.json().catch(()=>({error:"Failed to parse error response"}));setErrorState(t,`Error: ${n?.error||e.value.statusText}`,e.value.status)}else setErrorState(t,"Network error fetching balance sheet.")}catch(n){setErrorState(t,"Error displaying balance sheet data.")}}
    async function fetchMarketMovers(){setLoadingState(gainersResultEl,"market"),setLoadingState(losersResultEl,"market"),setLoadingState(activeResultEl,"market");try{const[e,t,n]=await Promise.allSettled([fetch("/market/gainers"),fetch("/market/losers"),fetch("/market/active")]);processMarketList(e,gainersResultEl,"gainer"),processMarketList(t,losersResultEl,"loser"),processMarketList(n,activeResultEl,"active")}catch(o){setErrorState(gainersResultEl,"Failed to load"),setErrorState(losersResultEl,"Failed to load"),setErrorState(activeResultEl,"Failed to load")}}
    async function processMarketList(e,t,n){if(!t)return;clearContent(t);try{if("fulfilled"===e.status&&e.value.ok){const o=await e.value.json();if(Array.isArray(o)&&o.length>0){let e='<ul class="market-list space-y-2">';o.slice(0,10).forEach(o=>{const t=o.symbol||o.ticker||"N/A",r=o.name||"";let a="N/A",s="N/A",c="",i="";"gainer"===n||"loser"===n?(a=o.changesPercentage?.toFixed(2)??"N/A",c=parseFloat(a)>=0?"change-positive":"change-negative",i=`<span class="${c}">${parseFloat(a)>=0?"+":""}${a}%</span>`):i=`$${o.price?.toFixed(2)??"N/A"}`,e+=`<li class="flex justify-between items-center text-sm"><div class="symbol-name truncate mr-2" title="${r||t}"><strong>${t}</strong><br><small class="text-gray-400 truncate block">${r}</small></div><div class="price-change text-right flex-shrink-0">${i}</div></li>`}),e+="</ul>",t.innerHTML=e}else t.innerHTML=`<p class="text-gray-400 text-sm">No ${n} data available.</p>`}else if("fulfilled"===e.status){const o=await e.value.json().catch(()=>({error:`Failed to parse ${n} error`}));setErrorState(t,`Error loading ${n}: ${o.error||e.value.statusText}`,e.value.status)}else setErrorState(t,`Network error loading ${n}`)}catch(o){setErrorState(t,`Error processing ${n} data`)}}
    async function addToWatchlist(e){if(!e||!addToWatchlistBtn)return;addToWatchlistBtn.disabled=!0;const t=addToWatchlistBtn.querySelector("span");t&&(t.textContent="Adding...");const n=new FormData;n.append("symbol",e);try{const o=await fetch("{{ url_for('add_to_watchlist') }}",{method:"POST",body:n}),r=await o.json();o.ok&&r.success?(showToast(r.message||`${e} added to watchlist.`),t&&(t.textContent="Added!"),addSymbolToWatchlistUI(e)):(showToast(r.error||`Failed to add ${e} to watchlist.`,!0),addToWatchlistBtn.disabled=!1,t&&(t.textContent="Watchlist"))}catch(o){showToast("Network error adding symbol to watchlist.",!0),addToWatchlistBtn.disabled=!1,t&&(t.textContent="Watchlist")}}
    async function removeFromWatchlist(e){if(!e)return;const t=watchlistListEl?watchlistListEl.querySelector(`li[data-symbol="${e}"]`):null,n=t?t.querySelector("button.remove-watchlist-btn"):null;n&&(n.disabled=!0);const o=new FormData;o.append("symbol",e);try{const r=await fetch("{{ url_for('remove_from_watchlist') }}",{method:"POST",body:o}),a=await r.json();r.ok&&a.success?(showToast(a.message||`${e} removed from watchlist.`),t&&(t.remove(),watchlistListEl&&!watchlistListEl.children.length&&watchlistResultEl&&(watchlistResultEl.innerHTML='<p class="text-gray-400 text-sm">Your watchlist is empty.</p>')),addToWatchlistBtn&&e===currentSymbolFmp&&(addToWatchlistBtn.disabled=!1,addToWatchlistBtn.querySelector("span")&&(addToWatchlistBtn.querySelector("span").textContent="Watchlist"))):(showToast(a.error||`Failed to remove ${e}.`,!0),n&&(n.disabled=!1))}catch(r){showToast("Network error removing symbol from watchlist.",!0),n&&(n.disabled=!1)}}
    function addSymbolToWatchlistUI(e){if(!watchlistResultEl)return;let t=document.getElementById("watchlist-list");if(!t){const e=watchlistResultEl.querySelector("p");e&&e.remove(),t=document.createElement("ul"),t.id="watchlist-list",watchlistResultEl.appendChild(t)}if(t.querySelector(`li[data-symbol="${e}"]`))return;const n=document.createElement("li");n.setAttribute("data-symbol",e);const o=document.createElement("button");o.className="watchlist-symbol-btn",o.textContent=e,o.onclick=()=>fetchData(e);const r=document.createElement("button");r.className="remove-watchlist-btn",r.title=`Remove ${e}`,r.innerHTML="&times;",r.onclick=()=>removeFromWatchlist(e),n.appendChild(o),n.appendChild(r),t.appendChild(n)}
    
    // --- NEW: Alert Functions ---
    async function fetchAndDisplayAlerts(symbol) {
        if (!alertListEl) return;
        alertListEl.innerHTML = '<div class="skeleton-line w-3/4 mx-auto"></div>'; // Simple skeleton
        try {
            const response = await fetch(`/api/alerts/${symbol}`);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Failed to fetch alerts');
            }
            const alerts = await response.json();
            alertListEl.innerHTML = ''; // Clear skeleton
            if (alerts.length === 0) {
                alertListEl.innerHTML = '<p class="text-xs text-gray-500 text-center mt-2">No active alerts for this symbol.</p>';
            } else {
                alerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.dataset.alertId = alert.id;
                    li.innerHTML = `
                        <span>Alert if price is <strong>${alert.condition} $${alert.target_price}</strong></span>
                        <button class="remove-alert-btn" onclick="deleteAlert(${alert.id})">&times;</button>
                    `;
                    alertListEl.appendChild(li);
                });
            }
        } catch (error) {
            alertListEl.innerHTML = `<p class="text-xs text-red-500 text-center mt-2">${error.message}</p>`;
        }
    }

    async function createAlert(event) {
        event.preventDefault();
        const condition = document.getElementById('alert-condition').value;
        const target_price = document.getElementById('alert-price').value;

        if (!currentSymbolFmp || !condition || !target_price) {
            showToast('Missing data to create alert.', true);
            return;
        }

        const formData = new FormData();
        formData.append('symbol', currentSymbolFmp);
        formData.append('condition', condition);
        formData.append('target_price', target_price);

        try {
            const response = await fetch('/alerts/create', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to create alert.');
            }
            showToast(result.message || 'Alert created successfully!');
            fetchAndDisplayAlerts(currentSymbolFmp); // Refresh list
            alertForm.reset();
        } catch (error) {
            showToast(error.message, true);
        }
    }

    async function deleteAlert(alertId) {
        try {
            const response = await fetch(`/alerts/delete/${alertId}`, { method: 'POST' });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to delete alert.');
            }
            showToast(result.message || 'Alert deleted.');
            // Remove the alert from the list in the UI
            const alertItem = alertListEl.querySelector(`li[data-alert-id='${alertId}']`);
            if (alertItem) {
                alertItem.remove();
            }
        } catch (error) {
            showToast(error.message, true);
        }
    }

    if (alertForm) {
        alertForm.addEventListener('submit', createAlert);
    }
    // --- End Alert Functions ---

    document.addEventListener("DOMContentLoaded",()=>{fetchMarketMovers();const e=new URLSearchParams(window.location.search).get("query");e?(symbolInputEl&&(symbolInputEl.value=decodeURIComponent(e)),fetchData(decodeURIComponent(e))):setLoadingState(gainersResultEl,"market"),setLoadingState(losersResultEl,"market"),setLoadingState(activeResultEl,"market")});
</script>
{% endblock %}

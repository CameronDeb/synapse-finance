{% extends "base.html" %}

{% block title %}Stock Screener - Synapse Finance{% endblock %}

{% block head_styles %}
{{ super() }}
<style>
    .screener-container {
        background-color: #1e1e1e;
        padding: 2rem;
        border-radius: 0.75rem;
        border: 1px solid #333;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* --- Filter Form Grouping --- */
    .filter-fieldset {
        border: 1px solid #374151;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    .filter-legend {
        padding: 0 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: #00bfa5;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
    }

    .filter-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #a0aec0;
        font-size: 0.875rem;
    }

    .filter-group select,
    .filter-group input[type="number"] {
        background-color: #2d3748;
        border: 1px solid #4a5568;
        color: #e2e8f0;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        width: 100%;
        font-size: 0.9rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-group select:focus,
    .filter-group input[type="number"]:focus {
        border-color: #00bfa5;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 191, 165, 0.2);
    }
    
    /* --- Buttons --- */
    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .screener-button {
        background-image: linear-gradient(to right, #00bfa5, #00a995);
        color: #ffffff;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .screener-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 7px 10px rgba(0, 0, 0, 0.2);
    }
    .screener-button:disabled {
        background: #4a5568;
        cursor: not-allowed;
        opacity: 0.7;
    }
    
    .reset-button {
        background-color: transparent;
        color: #a0aec0;
        border: 1px solid #4a5568;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
    }
    .reset-button:hover {
        background-color: #2d3748;
        color: #e2e8f0;
    }

    /* --- Results Table --- */
    #screener-results-container {
        min-height: 150px;
        /* Added for smooth scrolling */
        scroll-margin-top: 2rem;
    }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    .results-table th, 
    .results-table td {
        padding: 1rem 1.25rem;
        text-align: left;
    }
    .results-table th {
        border-bottom: 2px solid #00bfa5;
        color: #a0aec0;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }
    .results-table td {
        border-bottom: 1px solid #333;
        color: #e2e8f0;
    }
    .results-table td:not(:first-child) { text-align: right; }
    .results-table tbody tr { transition: background-color 0.2s ease; }
    .results-table tbody tr:hover { background-color: #2d3748; }
    .results-table a {
        color: #00bfa5;
        font-weight: 500;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    .results-table a:hover { color: #81e6d9; }
    
    /* --- Empty / Initial State --- */
    .results-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 1rem;
        text-align: center;
        color: #718096;
    }
    .results-empty-state svg {
        width: 3rem;
        height: 3rem;
        margin-bottom: 1rem;
    }

    /* --- UPDATED: One-Click Screener Card Styles --- */
    .cta-button {
        background-color: #00bfa5; color: #121212; transition: background-color 0.2s ease; font-weight: 600; padding: 0.5rem 1.25rem; border-radius: 0.375rem; border: none; cursor: pointer;
    }
    .cta-button:hover { background-color: #008c7a; }
    .screener-card {
        background-color: #2d3748;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        /* This is the new underglow effect */
        box-shadow: 0 10px 30px -15px rgba(0, 191, 165, 0.2);
    }
    .screener-card:hover {
        transform: translateY(-4px);
        /* This makes the glow stronger on hover */
        box-shadow: 0 12px 40px -15px rgba(0, 191, 165, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto">
    {% if current_user.is_pro %}
        <div class="screener-container mb-8">
            <h2 class="text-2xl font-bold text-white mb-2">Discover Opportunities</h2>
            <p class="text-gray-400 mb-6">Start with our pre-built screens to find your next investment.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="screener-card p-6 border border-gray-700 rounded-lg flex flex-col">
                    <h3 class="font-semibold text-lg text-white">Undervalued Classics</h3>
                    <p class="text-sm text-gray-400 mt-1 mb-4 flex-grow">Established companies trading at a low price-to-earnings ratio.</p>
                    <button onclick="runPrebuiltScreener('undervalued')" class="cta-button self-start">View Stocks</button>
                </div>
                <div class="screener-card p-6 border border-gray-700 rounded-lg flex flex-col">
                    <h3 class="font-semibold text-lg text-white">High-Growth Tech</h3>
                    <p class="text-sm text-gray-400 mt-1 mb-4 flex-grow">Tech companies with strong recent performance and analyst ratings.</p>
                    <button onclick="runPrebuiltScreener('growth_tech')" class="cta-button self-start">View Stocks</button>
                </div>
                <div class="screener-card p-6 border border-gray-700 rounded-lg flex flex-col">
                    <h3 class="font-semibold text-lg text-white">Top Dividend Payers</h3>
                    <p class="text-sm text-gray-400 mt-1 mb-4 flex-grow">Companies that provide a high dividend yield to investors.</p>
                    <button onclick="runPrebuiltScreener('dividends')" class="cta-button self-start">View Stocks</button>
                </div>
            </div>
        </div>

        <div class="screener-container">
             <h2 class="text-2xl font-bold text-white mb-2">Advanced Screener</h2>
            <p class="text-gray-400 mb-6">Or, build your own screen using advanced filters to find investments that match your criteria.</p>
            <form id="screener-form">
                <fieldset class="filter-fieldset">
                    <legend class="filter-legend">Company Metrics</legend>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="marketCapMin">Market Cap (Min Billions)</label>
                            <input type="number" id="marketCapMin" name="marketCapMin" placeholder="e.g., 2">
                        </div>
                        <div class="filter-group">
                            <label for="marketCapMax">Market Cap (Max Billions)</label>
                            <input type="number" id="marketCapMax" name="marketCapMax" placeholder="e.g., 2000">
                        </div>
                        <div class="filter-group">
                            <label for="betaMin">Beta (Min)</label>
                            <input type="number" id="betaMin" name="betaMin" step="any" placeholder="e.g., 0.5">
                        </div>
                        <div class="filter-group">
                            <label for="betaMax">Beta (Max)</label>
                            <input type="number" id="betaMax" name="betaMax" step="any" placeholder="e.g., 1.5">
                        </div>
                        <div class="filter-group">
                            <label for="volumeMin">Avg. Volume (Min Millions)</label>
                            <input type="number" id="volumeMin" name="volumeMin" step="any" placeholder="e.g., 1">
                        </div>
                        <div class="filter-group">
                            <label for="volumeMax">Avg. Volume (Max Millions)</label>
                            <input type="number" id="volumeMax" name="volumeMax" step="any" placeholder="e.g., 500">
                        </div>
                    </div>
                </fieldset>
                
                <fieldset class="filter-fieldset">
                    <legend class="filter-legend">Valuation & Financials</legend>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="peMin">P/E Ratio (Min)</label>
                            <input type="number" id="peMin" name="peMin" step="any" placeholder="e.g., 5">
                        </div>
                        <div class="filter-group">
                            <label for="peMax">P/E Ratio (Max)</label>
                            <input type="number" id="peMax" name="peMax" step="any" placeholder="e.g., 50">
                        </div>
                        <div class="filter-group">
                            <label for="dividendMin">Dividend Yield (Min %)</label>
                            <input type="number" id="dividendMin" name="dividendMin" step="any" placeholder="e.g., 2">
                        </div>
                        <div class="filter-group">
                            <label for="dividendMax">Dividend Yield (Max %)</label>
                            <input type="number" id="dividendMax" name="dividendMax" step="any" placeholder="e.g., 10">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="filter-fieldset">
                    <legend class="filter-legend">Categorization</legend>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="sector">Sector</label>
                            <select id="sector" name="sector">
                                <option value="">Any</option>
                                <option value="Technology">Technology</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Financial Services">Financial Services</option>
                                <option value="Consumer Cyclical">Consumer Cyclical</option>
                                <option value="Industrials">Industrials</option>
                                <option value="Energy">Energy</option>
                                <option value="Consumer Defensive">Consumer Defensive</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Communication Services">Communication Services</option>
                                <option value="Basic Materials">Basic Materials</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="country">Country</label>
                            <select id="country" name="country">
                                <option value="US">USA</option>
                                <option value="CA">Canada</option>
                                <option value="GB">United Kingdom</option>
                                <option value="DE">Germany</option>
                                <option value="JP">Japan</option>
                                <option value="">Any</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
                
                <div class="button-group">
                    <button type="button" id="run-screener-btn" class="screener-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <span>Run Screener</span>
                    </button>
                    <button type="reset" class="reset-button">Reset Filters</button>
                </div>
            </form>
        </div>

        <div class="screener-container mt-8" id="results-anchor">
            <h2 class="text-xl font-semibold text-white mb-4">Results</h2>
            <div id="screener-results-container" class="overflow-x-auto">
                <div class="results-empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.25 21l-.648-.428a2.25 2.25 0 01-1.47-2.122L14.25 15l.428-.648a2.25 2.25 0 012.122-1.47L18 12.75l.648.428a2.25 2.25 0 011.47 2.122L20.25 15l-.428.648a2.25 2.25 0 01-2.122 1.47L18 18.75l-.648.428a2.25 2.25 0 01-1.47 2.122z" />
                    </svg>
                    <p class="font-semibold">Your results will appear here</p>
                    <p>Select a pre-built screen or use the advanced filters to begin.</p>
                </div>
            </div>
        </div>
    {% else %}
        <div class="text-center py-10 bg-[#1e1e1e] rounded-lg">
            <h2 class="text-2xl font-semibold text-white mb-4">Access Denied</h2>
            <p class="text-gray-400 mb-6">The Stock Screener is a Pro feature. Please upgrade to access.</p>
            <a href="{{ url_for('pricing_page') }}" class="cta-button inline-block">View Pricing</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block body_scripts %}
{{ super() }}
{% if current_user.is_pro %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENT SELECTORS ---
    const runScreenerBtn = document.getElementById('run-screener-btn');
    const resultsContainer = document.getElementById('screener-results-container');
    const screenerForm = document.getElementById('screener-form');
    const initialResultsHTML = resultsContainer.innerHTML;
    const resultsAnchor = document.getElementById('results-anchor');

    // --- HELPER FUNCTIONS ---
    const formatNum = (num, digits = 2) => (num || num === 0) ? num.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits }) : "N/A";
    const formatLargeNum = (num) => {
        if (num === null || num === undefined) return "N/A";
        if (Math.abs(num) >= 1e9) return formatNum(num / 1e9, 2) + " B";
        if (Math.abs(num) >= 1e6) return formatNum(num / 1e6, 2) + " M";
        return num.toLocaleString();
    };

    // --- ONE-CLICK SCREENER LOGIC ---
    const prebuiltScreeners = {
        undervalued: {
            peMax: 15,
            marketCapMin: 10,
            dividendMin: 2
        },
        growth_tech: {
            sector: 'Technology',
            peMin: 20
        },
        dividends: {
            dividendMin: 4
        }
    };

    window.runPrebuiltScreener = async function(screenerName) {
        resultsContainer.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
        const filters = prebuiltScreeners[screenerName];
        const params = new URLSearchParams(filters).toString();
        
        await fetchAndRenderScreener(`/api/stock-screener?${params}`);

        // --- NEW: Scroll to results ---
        resultsAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    // --- ADVANCED SCREENER LOGIC ---
    screenerForm.addEventListener('reset', function() {
        resultsContainer.innerHTML = initialResultsHTML;
    });

    runScreenerBtn.addEventListener('click', async function() {
        resultsContainer.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
        runScreenerBtn.disabled = true;

        const formData = new FormData(screenerForm);
        const params = new URLSearchParams();
        for (const pair of formData) {
            if (pair[1]) {
                params.append(pair[0], pair[1]);
            }
        }
        await fetchAndRenderScreener(`/api/stock-screener?${params.toString()}`);
        runScreenerBtn.disabled = false;
    });

    // --- SHARED DATA FETCHING & RENDERING LOGIC ---
    async function fetchAndRenderScreener(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: "Server error occurred" }));
                throw new Error(errorData.error || `HTTP error ${response.status}`);
            }
            const results = await response.json();
            renderScreenerResults(results);
        } catch (error) {
            console.error("Screener error:", error);
            resultsContainer.innerHTML = `<p class="text-red-500 p-4">Error running screener: ${error.message}</p>`;
        }
    }

    function renderScreenerResults(results) {
        let originalResultCount = results.length;
        const isProUser = {{ current_user.is_pro|tojson }};

        if (!isProUser && results.length > 3) {
            results = results.slice(0, 3);
        }

        if (!results || results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="results-empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.028A6 6 0 0018 12a6 6 0 00-2.818-5.028M12 18a6 6 0 01-3.182-1.028M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 9.562a2.25 2.25 0 114.5 0V12a2.25 2.25 0 01-4.5 0V9.562z" /></svg>
                    <p class="font-semibold">No stocks match your criteria</p>
                    <p>Try adjusting your filters for a broader search.</p>
                </div>`;
            return;
        }

        let tableHTML = '<table class="results-table"><thead><tr>';
        const headers = ['Symbol', 'Name', 'Price', 'Market Cap', 'Volume', 'Beta', 'P/E', 'Div Yield (%)', 'Sector'];
        headers.forEach(h => tableHTML += `<th>${h}</th>`);
        tableHTML += '</tr></thead><tbody>';

        results.forEach(stock => {
            tableHTML += '<tr>';
            tableHTML += `<td><strong><a href="/dashboard?query=${stock.symbol}" target="_blank">${stock.symbol || 'N/A'}</a></strong></td>`;
            tableHTML += `<td>${stock.companyName || 'N/A'}</td>`;
            tableHTML += `<td>${formatNum(stock.price)}</td>`;
            tableHTML += `<td>${formatLargeNum(stock.marketCap)}</td>`;
            tableHTML += `<td>${formatLargeNum(stock.volume)}</td>`;
            tableHTML += `<td>${formatNum(stock.beta)}</td>`;
            tableHTML += `<td>${formatNum(stock.peRatio)}</td>`;
            tableHTML += `<td>${formatNum(stock.dividendYield)}</td>`;
            tableHTML += `<td>${stock.sector || 'N/A'}</td>`;
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        
        if (!isProUser && originalResultCount > 3) {
            tableHTML += `
                <div class="text-center py-6 px-4 border-t-2 border-dashed border-yellow-500/30 mt-4">
                    <h3 class="font-semibold text-yellow-400">Upgrade to Pro to see ${originalResultCount - 3} more results</h3>
                    <p class="text-gray-400 mt-1 text-sm">Unlock the full list and all advanced features.</p>
                    <a href="{{ url_for('pricing_page') }}" class="cta-button inline-block mt-4">View Pro Pricing</a>
                </div>
            `;
        }

        resultsContainer.innerHTML = tableHTML;
    }

    window.renderScreenerResults = renderScreenerResults;
});
</script>
{% endif %}
{% endblock %}
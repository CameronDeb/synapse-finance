{% extends "base.html" %}

{% block title %}Synapse Finance - Intelligent Market Analysis{% endblock %}

{% block head_styles %}
{{ super() }}
<style>
    .sticky-ticker { position: sticky; top: 60px; z-index: 40; width: 100%; background-color: rgba(30, 30, 30, 0.8); backdrop-filter: blur(10px); padding-top: 8px; padding-bottom: 8px; border-bottom: 1px solid #333; overflow: hidden; min-height: 38px; }
    .ticker-wrap { display: flex; width: max-content; animation: scroll-ticker 60s linear infinite; }
    .ticker-item { display: inline-flex; align-items: center; padding: 0 1.5rem; white-space: nowrap; font-size: 0.875rem; color: #bbb; }
    .ticker-item strong { color: #e0e0e0; margin-right: 0.75rem; font-weight: 500; }
    .ticker-item span { margin-left: 0.5rem; }
    .ticker-item .change-positive, .change-positive { color: #4ade80; text-shadow: 0 0 8px rgba(74, 222, 128, 0.5); }
    .ticker-item .change-negative, .change-negative { color: #f87171; text-shadow: 0 0 8px rgba(248, 113, 113, 0.5); }
    .ticker-wrap:hover { animation-play-state: paused; }
    @keyframes scroll-ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    .hero-section { padding-top: 6rem; padding-bottom: 8rem; position: relative; z-index: 1; }
    
    .hero-headline {
        color: #f0f0f0;
        text-shadow: 0 2px 15px rgba(0, 0, 0, 0.4);
        letter-spacing: -0.02em;
    }
    .word-wrapper { display: inline-block; overflow: hidden; vertical-align: bottom; }
    .word-reveal { display: inline-block; transform: translateY(110%); transition: transform 0.8s cubic-bezier(0.2, 1, 0.3, 1); }

    .hero-input { background-color: #222; border: 1px solid #444; color: #e0e0e0; padding: 0.75rem 1rem; border-radius: 0.375rem; transition: all 0.2s ease; }
    .hero-input:focus { border-color: #00bfa5; outline: none; box-shadow: 0 0 15px rgba(0, 191, 165, 0.4); }
    
    .hero-button { background-color: #00bfa5; color: #121212; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 191, 165, 0.2); }
    .hero-button:hover { background-color: #00dfb5; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 191, 165, 0.4); }

    .dynamic-card { 
        background-color: rgba(30, 30, 30, 0.7); 
        border: 1px solid #333; 
        border-radius: 0.75rem; 
        padding: 1.5rem; 
        backdrop-filter: blur(10px); 
        width: 100%; 
        max-width: 380px; 
        transition: all 0.3s ease-in-out;
        box-shadow: 0 10px 30px -15px rgba(0, 191, 165, 0.3), 0 10px 25px rgba(0,0,0,0.3);
    }
    .dynamic-card-header { display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid #333; padding-bottom: 1rem; margin-bottom: 1rem; }
    .dynamic-card-logo { width: 48px; height: 48px; border-radius: 50%; background-color: #444; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem; }
    .dynamic-card-price { font-size: 2.25rem; font-weight: 700; }
    .dynamic-card-change { font-size: 1.125rem; font-weight: 500; }
    .metric { display: flex; justify-content: space-between; font-size: 0.9rem; padding-top: 0.75rem; }
    .metric-label { color: #aaa; }
    .metric-value { font-weight: 600; }
</style>
{% endblock %}

{% block below_header_full_width %}
<div class="sticky-ticker">
    <div class="ticker-wrap" id="tickerWrap">
        <div class="ticker-item">Loading tickers...</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
        <div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white leading-tight mb-6">
                <span class="word-wrapper"><span class="word-reveal">Intelligent</span></span>
                <span class="word-wrapper"><span class="word-reveal">Stock</span></span>
                <span class="word-wrapper"><span class="word-reveal">Analysis</span></span>
                <span class="block">
                    <span class="word-wrapper"><span class="word-reveal">and</span></span>
                    <span class="word-wrapper"><span class="word-reveal">Portfolio</span></span>
                    <span class="word-wrapper"><span class="word-reveal">Tracking</span></span>
                </span>
            </h1>
            <p class="text-lg text-gray-400 mb-8 max-w-xl">
                Your personal financial command center. Get real-time stock quotes, in-depth analysis, ratings, and financial news to make smarter investment decisions.
            </p>
            <form action="{{ url_for('dashboard') }}" method="GET" class="flex flex-col sm:flex-row gap-4">
                <input type="text" name="query" placeholder="Enter symbol (e.g., AAPL)" class="hero-input flex-grow" required>
                <button type="submit" class="hero-button flex items-center justify-center space-x-2">
                    <span>Analyze</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"> <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" /> </svg>
                </button>
            </form>
            <p class="text-sm text-gray-500 mt-4">Powered by Market Data APIs</p>
        </div>
        <div class="hidden md:flex md:justify-center md:items-center">
            <div id="dynamic-card" class="dynamic-card">
                <div class="dynamic-card-header">
                    <div id="card-logo" class="dynamic-card-logo"></div>
                    <div>
                        <h3 id="card-symbol" class="text-2xl font-bold"></h3>
                        <p id="card-name" class="text-sm text-gray-400"></p>
                    </div>
                </div>
                <div>
                    <span id="card-price" class="dynamic-card-price"></span>
                    <span id="card-change" class="dynamic-card-change ml-2"></span>
                </div>
                <div class="mt-4 space-y-1">
                    <div class="metric">
                        <span class="metric-label">Volume</span>
                        <span id="card-volume" class="metric-value"></span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Market Cap</span>
                        <span id="card-marketCap" class="metric-value"></span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">P/E Ratio</span>
                        <span id="card-pe" class="metric-value"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const tickerWrap = document.getElementById('tickerWrap');
        async function fetchTickerData() {
            try {
                const response = await fetch('/api/ticker-data');
                if (!response.ok) throw new Error('Failed to fetch ticker data');
                const data = await response.json();
                populateTickers(data);
            } catch (error) {
                console.error("Ticker error:", error);
                tickerWrap.innerHTML = '<div class="ticker-item">Could not load live ticker data.</div>';
            }
        }
        function populateTickers(tickerData) {
            if (!tickerData || tickerData.length === 0) { tickerWrap.innerHTML = '<div class="ticker-item">Ticker data unavailable.</div>'; return; }
            let displayData = [...tickerData, ...tickerData];
            let tickerHtml = '';
            displayData.forEach(data => {
                if (!data || !data.symbol) return;
                const changeClass = (data.changesPercentage || 0) >= 0 ? 'change-positive' : 'change-negative';
                const price = (data.price || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const change = (data.changesPercentage || 0).toFixed(2);
                const sign = (data.changesPercentage || 0) >= 0 ? '+' : '';
                tickerHtml += `<div class="ticker-item"><strong>${data.symbol}</strong><span>${price}</span><span class="${changeClass}">${sign}${change}%</span></div>`;
            });
            tickerWrap.innerHTML = tickerHtml;
        }
        fetchTickerData();

        const canvas = document.getElementById('hero-canvas');
        if (canvas && typeof THREE !== 'undefined') {
            let scene, camera, renderer, points, lines;
            let mouseX = 0, mouseY = 0;
            let windowHalfX = window.innerWidth / 2;
            let windowHalfY = window.innerHeight / 2;

            const init = () => {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.z = 250;
                renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x000000, 0);
                const vertices = [];
                for (let i = 0; i < 300; i++) { vertices.push((Math.random() - 0.5) * 800, (Math.random() - 0.5) * 800, (Math.random() - 0.5) * 800); }
                const geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                points = new THREE.Points(geometry, new THREE.PointsMaterial({ color: 0x00bfa5, size: 2, transparent: true, opacity: 0.7 }));
                scene.add(points);
                const lineGeometry = new THREE.BufferGeometry();
                const linePositions = [];
                const positions = geometry.attributes.position.array;
                for(let i = 0; i < 150; i++) {
                    linePositions.push(positions[i*3], positions[i*3+1], positions[i*3+2]);
                    linePositions.push(positions[((i*5)%300)*3], positions[((i*5)%300)*3+1], positions[((i*5)%300)*3+2]);
                }
                lineGeometry.setAttribute('position', new THREE.Float32BufferAttribute(linePositions, 3));
                lines = new THREE.LineSegments(lineGeometry, new THREE.LineBasicMaterial({ color: 0x00bfa5, transparent: true, opacity: 0.1 }));
                scene.add(lines);
                window.addEventListener('resize', onWindowResize);
                document.addEventListener('mousemove', onDocumentMouseMove);
            };
            const onWindowResize = () => {
                windowHalfX = window.innerWidth / 2;
                windowHalfY = window.innerHeight / 2;
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            };
            const onDocumentMouseMove = (event) => {
                mouseX = (event.clientX - windowHalfX) * 0.1;
                mouseY = (event.clientY - windowHalfY) * 0.1;
            };
            const animate = () => {
                requestAnimationFrame(animate);
                camera.position.x += (mouseX - camera.position.x) * 0.05;
                camera.position.y += (-mouseY - camera.position.y) * 0.05;
                camera.lookAt(scene.position);
                const time = Date.now() * 0.0001;
                points.rotation.y = time;
                lines.rotation.y = time;
                renderer.render(scene, camera);
            };
            init();
            animate();
        }
        
        const words = document.querySelectorAll('.word-reveal');
        words.forEach((word, index) => {
            setTimeout(() => {
                word.style.transform = 'translateY(0)';
            }, 100 * index + 250);
        });

        const dynamicCard = document.getElementById('dynamic-card');
        if (dynamicCard) {
            const mockData = [
                { symbol: 'AAPL', name: 'Apple Inc.', price: 172.45, change: 2.15, pct: 1.26, volume: '95M', marketCap: '2.8T', pe: 28.5, color: '#A2A2A2' },
                { symbol: 'TSLA', name: 'Tesla, Inc.', price: 250.80, change: -3.40, pct: -1.34, volume: '120M', marketCap: '800B', pe: 75.2, color: '#E82127' },
                { symbol: 'NVDA', name: 'NVIDIA Corp.', price: 475.12, change: 8.55, pct: 1.83, volume: '60M', marketCap: '1.2T', pe: 60.1, color: '#76B900' }
            ];
            let dataIndex = 0;
            const updateCard = () => {
                const data = mockData[dataIndex];
                dynamicCard.style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('card-logo').textContent = data.symbol.substring(0, 2);
                    document.getElementById('card-logo').style.backgroundColor = data.color;
                    document.getElementById('card-symbol').textContent = data.symbol;
                    document.getElementById('card-name').textContent = data.name;
                    document.getElementById('card-price').textContent = `$${data.price.toFixed(2)}`;
                    const changeEl = document.getElementById('card-change');
                    const sign = data.change >= 0 ? '+' : '';
                    changeEl.textContent = `${sign}${data.change.toFixed(2)} (${sign}${data.pct.toFixed(2)}%)`;
                    changeEl.className = `dynamic-card-change ml-2 ${data.change >= 0 ? 'change-positive' : 'change-negative'}`;
                    document.getElementById('card-volume').textContent = data.volume;
                    document.getElementById('card-marketCap').textContent = `$${data.marketCap}`;
                    document.getElementById('card-pe').textContent = data.pe.toFixed(2);
                    dynamicCard.style.opacity = 1;
                    dataIndex = (dataIndex + 1) % mockData.length;
                }, 300);
            };
            setInterval(updateCard, 4000);
            updateCard();
        }
    });
</script>
{% endblock %}